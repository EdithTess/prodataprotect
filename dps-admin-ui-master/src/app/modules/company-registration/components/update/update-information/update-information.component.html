
<fury-page-layout mode="card">
    <fury-page-layout-header>
        <fury-breadcrumbs [@fadeInRight] [crumbs]="['New Registration']"
                          current="New Application"></fury-breadcrumbs>
    </fury-page-layout-header>

    <fury-page-layout-content [@fadeInUp]>
        <main class="fadeInUp _delay4ms">

            <!-- <app-page-breadcrumb [title]="'Application for New Registration / Renewal'"></app-page-breadcrumb> -->
        
            <mat-horizontal-stepper 
                [linear]="isLinear"
                [selectedIndex]="selectedIndex"
                labelPosition="bottom" #stepper>
        
                <mat-step [stepControl]="formGeneralInformation">
                    <ng-template matStepLabel>
                        <h3>Applicant</h3>
                    </ng-template>
        
                    <form [formGroup]="formGeneralInformation">
                        <h1 class="full-width step-header">Details of the applicant which could be an organisation or Individual that collects or processes Personal Data </h1>
        
                        <mat-form-field>
                            <mat-label>Name of Organisation <span class="required-field">required</span></mat-label>
                            <input appUppercase matInput formControlName="OrganizationName">       
                            <mat-error *ngIf="formGeneralInformation.get('OrganizationName').invalid">{{ getOrganizationNameErrorMessage() }}</mat-error>
                        </mat-form-field>  
        
                        <div class="telephone-code-number-wrapper">
                            <mat-form-field class="fadeInUp _delay2ms">
                                <mat-label>Pick one </mat-label>
                                <mat-select formControlName="PhoneNumberCode">
                                    <mat-option selected *ngIf="!selected" value="256">+256</mat-option>
                                    <!-- <mat-option selected *ngIf="!selected" value="256">+256 - Uganda</mat-option> -->
                                    <mat-option *ngFor="let code of countries" [value]="code.PhoneCode" (click)="selected = true">
                                        +{{ code.PhoneCode }}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
        
                            <!-- <mat-form-field class="fadeInUp _delay2ms" [hintLabel]="'Organisation Telephone Number.'"> -->
                            <mat-form-field class="fadeInUp _delay2ms">
                                <mat-label>Organisation Telephone Number <span class="required-field">required</span></mat-label>
                                <input type="text" maxlength="11" matInput appTelephoneFormaterDirective formControlName="PhoneNumber" placeholder="Ex. 414 318 111">
                                <mat-error *ngIf="formGeneralInformation.get('PhoneNumber').invalid">{{ getTelephoneNumberErrorMessage() }}</mat-error>
                            </mat-form-field> 
                        </div>                
        
                        <mat-form-field>
                            <mat-label>Organisation Email Address <span class="required-field">required</span></mat-label>
                            <input appRemoveSpaces matInput formControlName="EmailAddress">
                            <mat-error *ngIf="formGeneralInformation.get('EmailAddress').invalid">{{ getEmailAddressErrorMessage() }}</mat-error>
                        </mat-form-field>   
                                
                        <mat-form-field [hintLabel]="'Choose all that apply'">
                            <mat-label>Category <span class="required-field">required</span></mat-label>
                            <mat-select multiple formControlName="DPPActCategory">
                                <mat-option *ngFor="let cat of organisationCategories" [value]="cat.OrganisationCategoryId">
                                    {{ cat.OrganisationCategoryName }}
                                </mat-option>
                            </mat-select>   
                            <mat-error *ngIf="formGeneralInformation.get('DPPActCategory').invalid">{{ getSelectErrorMessage() }}</mat-error> 
                        </mat-form-field>                             
        
                        <mat-form-field>
                            <mat-label>Type of Organisation <span class="required-field">required</span></mat-label>
                            <mat-select formControlName="OrganizationTypeID" #typeOfOrganisation>
                                <mat-option *ngFor="let type of organisationTypes" (click)="OrganizationType = type.OrganisationType" [value]="type.OrganisationTypeID">
                                    {{ type.OrganisationType }}
                                </mat-option>
                            </mat-select>
                            <mat-error *ngIf="formGeneralInformation.get('OrganizationTypeID').invalid">{{ getSelectErrorMessage() }}</mat-error> 
                        </mat-form-field>                   
        
                        <mat-form-field *ngIf="typeOfOrganisation.value && typeOfOrganisation.value !== 4">
                            <mat-label>Country of Incorporation <span class="required-field">required</span></mat-label>
                            <mat-select formControlName="CountryOfIncorporation">
                                <mat-option *ngFor="let country of countries" (click)="CountryOfIncorporation = country.Name" [value]="country.CountryID">
                                    {{ country.Name }}
                                </mat-option>
                            </mat-select>
                            <mat-error *ngIf="formGeneralInformation.get('CountryOfIncorporation').invalid">{{ getSelectErrorMessage() }}</mat-error> 
                        </mat-form-field>        
        
                        <mat-form-field *ngIf="typeOfOrganisation.value && typeOfOrganisation.value !== 4">
                            <mat-label>Registration Number <span class="required-field">required</span></mat-label>
                            <input appUppercase appRemoveSpaces matInput maxlength="25" formControlName="URSBNumber"> 
                            <mat-error *ngIf="formGeneralInformation.get('URSBNumber').invalid">{{ getURSBNumberErrorMessage() }}</mat-error>
                        </mat-form-field>     
                        
                        <mat-form-field>
                            <mat-label>Sector <span class="required-field">required</span></mat-label>
                            <mat-select formControlName="SectorID" #Sector>
                                <mat-option *ngFor="let sector of sectors" (click)="SectorName = sector.Sector" [value]="sector.SectorID">
                                    {{ sector.Sector }}
                                </mat-option>
                            </mat-select>
                            <mat-error *ngIf="formGeneralInformation.get('SectorID').invalid">{{ getSelectErrorMessage() }}</mat-error>
                        </mat-form-field>        
                        
                        <mat-form-field hintLabel="If Other, Please specify the Sector." *ngIf="Sector.value === 14">
                            <mat-label>Specify Sector <span class="required-field">required</span></mat-label>
                            <input appUppercase matInput maxlength="50" formControlName="OtherSector">    
                            <mat-error *ngIf="formGeneralInformation.get('OtherSector').invalid">{{ getOtherSectorErrorMessage() }}</mat-error>
                        </mat-form-field>                 
        
                        <mat-form-field>
                            <mat-label>Physical Address <span class="required-field">required</span></mat-label>
                            <input appUppercase matInput maxlength="255" formControlName="Location">            
                            <mat-error *ngIf="formGeneralInformation.get('Location').invalid">{{ getLocationErrorMessage() }}</mat-error>                
                        </mat-form-field>  
        
                        <mat-form-field>
                            <mat-label>Nature of Business Categories<span class="required-field">required</span></mat-label>
                            <mat-select formControlName="NatureOfBusinessCat">
                                <mat-option *ngFor="let cat of natureOfBusinessCat" (click)="NatureOfBusinessCat = cat.NatureOfBusinessCategoryName" [value]="cat.NatureOfBusinessCatId">
                                    {{ cat.NatureOfBusinessCategoryName }}
                                </mat-option>
                            </mat-select>    
                            <mat-error *ngIf="formGeneralInformation.get('NatureOfBusinessCat').invalid">{{ getSelectErrorMessage() }}</mat-error>
                        </mat-form-field>                   
        
                        <mat-form-field [hintLabel]="'Choose all that apply'">
                            <mat-label>Nature of Business Sub-Categories <span class="required-field">required</span></mat-label>
                            <mat-select multiple formControlName="NatureOfBusinessSubCat">
                                <mat-option *ngFor="let sub of natureOfBusinessSubCat" [value]="sub.NatureOfBusinessSubCatId" [matTooltip]="sub.NatureOfBusinessSubCategoryName">
                                    {{ sub.NatureOfBusinessSubCategoryName }}
                                </mat-option>
                            </mat-select> 
                            <mat-error *ngIf="formGeneralInformation.get('NatureOfBusinessSubCat').invalid">{{ getSelectErrorMessage() }}</mat-error>   
                        </mat-form-field>                   
                    </form>
        
                    <div class="button-wrapper">
                               
        
                        <button 
                            [disabled]="formGeneralInformation.invalid"
                            mat-button 
                            class="next-btn" 
                            color="primary" 
                            matStepperNext>
                            Next
                        </button>
                    </div>             
                </mat-step>
        
                <mat-step [stepControl]="formOrganisationDetails">
                    <ng-template matStepLabel>
                        <h3>Data Protection <br />Officer</h3>
                    </ng-template>
        
                    <form [formGroup]="formOrganisationDetails">     
        
                        <h1 class="full-width step-header">Details of Data Protection Officer </h1>    
        
                        <div class="grouped-items" [ngClass]="{'full-width': formOrganisationDetails.get('DPORequired').value !== 'Yes'}">
                            <h3>Do you have a designated data protection officer ? </h3>
            
                            <mat-radio-group 
                                color="primary" 
                                formControlName="DPORequired" 
                                aria-label="Pick one">
                                <mat-radio-button value="Yes">Yes</mat-radio-button>
                                <mat-radio-button value="No">No</mat-radio-button>
                            </mat-radio-group>        
                        </div>                  
                        
                        <mat-form-field *ngIf="formOrganisationDetails.get('DPORequired').value === 'Yes'">
                            <mat-label>Name <span class="required-field">required</span></mat-label>
                            <input formControlName="DPOName" matInput>
                            <mat-error *ngIf="formOrganisationDetails.get('DPOName').invalid">{{ getDPONameErrorMessage() }}</mat-error>
                        </mat-form-field>
                
                        <mat-form-field *ngIf="formOrganisationDetails.get('DPORequired').value === 'Yes'">
                            <mat-label>Physical Address <span class="required-field">required</span></mat-label>
                            <input formControlName="DPOPhysicalAddress" maxlength="255" matInput>
                            <mat-error *ngIf="formOrganisationDetails.get('DPOPhysicalAddress').invalid">{{ getDPOPhysicalAddressErrorMessage() }}</mat-error>
                        </mat-form-field>
                        
                        <div class="telephone-code-number-wrapper" *ngIf="formOrganisationDetails.get('DPORequired').value === 'Yes'">
                            <mat-form-field class="fadeInUp _delay2ms">
                                <mat-label>Pick one </mat-label>
                                <mat-select formControlName="PhoneNumberCode">
                                    <mat-option selected *ngIf="!DPOSelected" value="256">+256</mat-option>
                                    <!-- <mat-option selected *ngIf="!selected" value="256">+256 - Uganda</mat-option> -->
                                    <mat-option *ngFor="let code of countries" [value]="code.PhoneCode" (click)="DPOSelected = true">
                                        +{{ code.PhoneCode }}
                                    </mat-option>
                                </mat-select>
                                <!-- <mat-error *ngIf="formGeneralInformation.get('PhoneNumberCode').invalid">{{ getSelectInputErrorMessage() }}</mat-error>      -->
                            </mat-form-field>
        
                            <!-- <mat-form-field class="fadeInUp _delay2ms" [hintLabel]="'Organisation Telephone Number.'"> -->
                            <mat-form-field class="fadeInUp _delay2ms">
                                <mat-label>Telephone Number <span class="required-field">required</span></mat-label>
                                <input type="text" maxlength="11" matInput appTelephoneFormaterDirective formControlName="DPOPhoneNumber" placeholder="Ex. 414 318 111">
                                <mat-error *ngIf="formOrganisationDetails.get('DPOPhoneNumber').invalid">{{ getDPOPhoneNumberErrorMessage() }}</mat-error>
                            </mat-form-field> 
                        </div>                  
                
                        <mat-form-field *ngIf="formOrganisationDetails.get('DPORequired').value === 'Yes'">
                            <mat-label>Email Address <span class="required-field">required</span></mat-label>
                            <input appRemoveSpaces formControlName="DPOEmailAddress" matInput>
                            <mat-error *ngIf="formOrganisationDetails.get('DPOEmailAddress').invalid">{{ getDPOEmailAddressErrorMessage() }}</mat-error>
                        </mat-form-field>       
        
                        <mat-form-field *ngIf="formOrganisationDetails.get('DPORequired').value === 'Yes'" class="full-width" hintLabel="Any other title held apart from DPO (Data Protection Officer).">
                            <mat-label>Title Held <span class="required-field">required</span></mat-label>
                            <textarea #PositionInput matInput formControlName="DPOPositionInOrganisation" maxlength="1000"></textarea>
                            <mat-hint align="end">{{ PositionInput.value.length }} / 1000</mat-hint>
                            <mat-error *ngIf="formOrganisationDetails.get('DPOPositionInOrganisation').invalid">{{ getDPOPositionInOrganisationErrorMessage() }}</mat-error>
                        </mat-form-field>                  
                    </form>
        
                    <div class="button-wrapper">       
                        <button mat-button class="back-btn" matStepperPrevious>Back</button>   
                        
                        

                        <button 
                            [disabled]="formOrganisationDetails.invalid"
                            mat-button 
                            class="next-btn" 
                            color="primary" 
                            matStepperNext>
                            Next
                        </button>
                    </div>             
                </mat-step>
        
                <mat-step [stepControl]="formPersonalDataHeld">
                    <ng-template matStepLabel>
                        <h3>Data Collected <br /> or Processed</h3>
                    </ng-template>
        
                    <form [formGroup]="formPersonalDataHeld" class="personal-data-affected">       
                        
                        <h1 class="full-width step-header">Description of Data collected or processed </h1>
        
                        <mat-form-field hintLabel="Choose all that apply." class="full-width">
                            <mat-label>Source of Data <span class="required-field">required</span></mat-label>
                            <mat-select multiple formControlName="SourceOfDataID">
                                <mat-option *ngFor="let source of dataSources" [value]="source.DataSourceID">
                                    {{ source.DataSource }}
                                </mat-option>
                            </mat-select>    
                            <mat-error *ngIf="formPersonalDataHeld.get('SourceOfDataID').invalid">{{ getSelectErrorMessage() }}</mat-error> 
                        </mat-form-field>        
        
                        <h1 class="full-width heading">Personal Data Collected Or Processed</h1>
                        
                        <section *ngFor="let category of dataCategories; let i = index" class="expand-section categories">        
                            <div>
                                <h3 [innerHTML]="category.DataCategory"></h3>
                                <mat-icon matTooltipPosition="right"  [matTooltip]="category.DataDescription">info</mat-icon>
                            </div>

                            <mat-checkbox
                                *ngFor="let SubCategory of category.SubCategories" 
                                [ngClass]="{'full-width': category.SubCategories.length === 1}"
                                color="primary"
                                [checked]="SubCategory.IsChecked"
                                (change)="onChangeSubCategory($event,SubCategory)"
                                [required]="'false'">
                                {{ SubCategory.DataSubCategory }}
                            </mat-checkbox>    
                        </section>
                    </form>
        
                    <div class="button-wrapper">       
                        <button mat-button class="back-btn" matStepperPrevious>Back</button>
        
                     

                        <button 
                            [disabled]="formPersonalDataHeld.invalid || selectedDataSubCategory.length === 0"
                            mat-button 
                            class="next-btn" 
                            color="primary" 
                            matStepperNext>
                            Next
                        </button>
                    </div>             
                </mat-step>
        
                <mat-step [stepControl]="formPurposeRetention">
                    <ng-template matStepLabel>
                        <h3>Purpose & Retention</h3>
                    </ng-template>
        
                    <form [formGroup]="formPurposeRetention">       
                        
                        <h1 class="full-width step-header">Description of Purpose for which data is collected or processed </h1>
        
                        <mat-form-field hintLabel="Why do you collect personal Data?">
                            <mat-label>For What Purpose ?<span class="required-field">required</span></mat-label>
                            <mat-select formControlName="Purpose" multiple>
                                <mat-option *ngFor="let purpose of dataPurposes" [value]="purpose.DataPurposeID">
                                    {{ purpose.DataPurpose }}
                                </mat-option>
                            </mat-select>  
                            <mat-error *ngIf="formPurposeRetention.get('Purpose').invalid">{{ getSelectErrorMessage() }}</mat-error>   
                        </mat-form-field>
        
                        <mat-form-field hintLabel="If the purpose is Collection / Processing is required by Law." *ngIf="SpecifyTheLaw">
                            <mat-label>Specify the Law <span class="required-field">required</span></mat-label>
                            <input matInput #SpecifyTheLawInput maxlength="1000" formControlName="SpecifyTheLaw">        
                            <mat-hint align="end">{{ SpecifyTheLawInput.value.length }} / 1000</mat-hint>    
                            <mat-error *ngIf="formPurposeRetention.get('SpecifyTheLaw').invalid">{{ getRequiredErrorMessage() }}</mat-error>
                        </mat-form-field>  
        
                        <mat-form-field hintLabel="If the purpose is to provide services / products to Individuals." *ngIf="ServiceOrProductProvided">
                            <mat-label>Specify the Service / Product Provided<span class="required-field">required</span></mat-label>
                            <input matInput #ServiceOrProductProvidedInput maxlength="1000" formControlName="ServiceOrProductProvided">     
                            <mat-hint align="end">{{ ServiceOrProductProvidedInput.value.length }} / 1000</mat-hint>    
                            <mat-error *ngIf="formPurposeRetention.get('ServiceOrProductProvided').invalid">{{ getRequiredErrorMessage() }}</mat-error>
                        </mat-form-field>  
        
                        <mat-form-field hintLabel="If the purpose is for Compliance with a Legal Obligation." *ngIf="SpecifyLegalObligation">
                            <mat-label>Specify the Legal Obligation<span class="required-field">required</span></mat-label>
                            <input matInput #SpecifyLegalObligationInput maxlength="1000" formControlName="SpecifyLegalObligation">  
                            <mat-hint align="end">{{ SpecifyLegalObligationInput.value.length }} / 1000</mat-hint>    
                            <mat-error *ngIf="formPurposeRetention.get('SpecifyLegalObligation').invalid">{{ getRequiredErrorMessage() }}</mat-error>
                        </mat-form-field>  
                        
                        <mat-form-field hintLabel="Approximate number of Personal Data Records held.">
                            <mat-label>Total Records <span class="optional-field">optional</span></mat-label>
                            <input appCurrencyDirective matInput maxlength="14" formControlName="TotalRecordsAtRegistration">                            
                            <mat-error *ngIf="formPurposeRetention.get('TotalRecordsAtRegistration').invalid">{{ getPatternErrorMessage() }}</mat-error>
                        </mat-form-field>  
                        
                        <mat-form-field hintLabel="The % annual growth of Personal Records held">
                            <mat-label>Percentage Annual Growth <span class="optional-field">optional</span></mat-label>
                            <input appCurrencyDirective matInput max="100" maxlength="3" formControlName="RecordPercentageGrowth">                            
                            <mat-error *ngIf="formPurposeRetention.get('RecordPercentageGrowth').invalid">{{ getRecordPercentageGrowthErrorMessage() }}</mat-error>
                            <mat-hint align="end">Max. 100%</mat-hint>      
                            <span matSuffix>%</span>
                        </mat-form-field>   
        
                        <mat-form-field hintLabel="Duration for which personal data shall be kept (Years).">
                            <mat-label>Retention period <span class="required-field">required</span></mat-label>
                            <input appCurrencyDirective max="100" matInput maxlength="3" formControlName="RetentionPeriod">                          
                            <mat-error *ngIf="formPurposeRetention.get('RetentionPeriod').invalid">{{ getRetentionPeriodErrorMessage() }}</mat-error>
                            <mat-hint align="end">Max. 100 years</mat-hint>      
                            <span matSuffix>Year(s)</span>
                        </mat-form-field>
                    </form>
        
                    <div class="button-wrapper">       
                        <button mat-button class="back-btn" matStepperPrevious>Back</button>
        
                      

                        <button 
                            [disabled]="formPurposeRetention.invalid"
                            mat-button 
                            class="next-btn" 
                            color="primary" 
                            matStepperNext>
                            Next
                        </button>
                    </div>             
                </mat-step>
        
                <mat-step [stepControl]="formThirdParties">
                    <ng-template matStepLabel>
                        <h3>Disclosure & Transfer</h3>
                    </ng-template>
        
                    <form [formGroup]="formThirdParties">
        
                        <h1 class="full-width step-header">List of persons or Bodies to whom personal data may be disclosed</h1>
                        
                        <div class="grouped-items full-width">
                            <h3>Do you disclose Personal Data to other Persons or Bodies ?</h3>
            
                            <mat-radio-group color="primary" aria-label="Pick one" formControlName="PersonalDataIsForDisclosure">
                                <mat-radio-button value="Yes">Yes</mat-radio-button>
                                <mat-radio-button value="No">No</mat-radio-button>
                            </mat-radio-group>        
                        </div>    

                        <section 
                            *ngIf="formThirdParties.get('PersonalDataIsForDisclosure').value === 'Yes'"
                            class="expand-section reduced-properties table-wrapper fadeInUp _delay3ms">
                            <button 
                                mat-button
                                color="primary"
                                [disabled]="processing"
                                class="add-item-button"
                                (click)="onAddAThirdParty()">
                                <div class="button-label">
                                    <mat-icon>add</mat-icon>                            
                                    <span>Add Person / Body</span>
                                </div>
                            </button>
                            
                            <div class="table-wrapper">
                                <table 
                                    mat-table 
                                    #thirdPartyMatSort="matSort"
                                    matSortDisableClear="true"
                                    [dataSource]="thirdPartyDataSource"
                                    matSort>
                    
                                    <ng-container matColumnDef="Count">
                                        <th mat-header-cell *matHeaderCellDef> # </th>
                                        <td mat-cell *matCellDef="let index = index"> {{ index + 1 }} </td>
                                    </ng-container>
                    
                                    <ng-container matColumnDef="NameOfThirdParty">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Person / Body </th>
                                        <td mat-cell *matCellDef="let row">{{ row.ThirdPartyName }}</td>
                                    </ng-container>          
                    
                                    <ng-container matColumnDef="Purpose">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Purpose </th>
                                        <td mat-cell *matCellDef="let row">{{ row.Purpose }}</td>
                                    </ng-container>                                 
                    
                                    <!-- Actions Column -->
                                    <ng-container matColumnDef="Actions">
                                        <th mat-header-cell *matHeaderCellDef> Actions </th>
                                        <td mat-cell *matCellDef="let row; let index = index">
                                            <button 
                                                mat-button 
                                                class="action-btn"
                                                [matMenuTriggerFor]="menu" 
                                                (click)="$event.stopPropagation()"
                                                matTooltip="See more options">
                                                <mat-icon>more_vert</mat-icon>
                                            </button>
                    
                                            <mat-menu yPosition="below" #menu="matMenu" class="more-options-mat-menu">
                    
                                                <button 
                                                    mat-menu-item 
                                                    (click)="$event.stopPropagation();onEditThirdParty(row)">
                                                    <mat-icon>edit</mat-icon>
                                                    <span>Make Changes</span>
                                                </button>
                                                      
                                                <hr />
                    
                                                <button 
                                                    mat-menu-item 
                                                    (click)="$event.stopPropagation();onRemoveThirdParty(row)">
                                                    <mat-icon color="warn">delete</mat-icon>
                                                    <span>Remove</span>
                                                </button>
                    
                                            </mat-menu>                                                  
                                        </td>
                                    </ng-container>
                    
                                    <tr mat-header-row *matHeaderRowDef="thirdPartyDisplayedColumns"></tr>
                                    <tr mat-row *matRowDef="let row; columns: thirdPartyDisplayedColumns;" class="mat-data-row"></tr>
                                </table>
        
                                <mat-paginator 
                                    #thirdPartyPaginator
                                    [pageSize]="10"
                                    [pageSizeOptions]="[5, 10]">
                                </mat-paginator>                    
                            </div>                
                        </section>    
                        
                        <hr class="full-width" />
        
                        <div class="grouped-items full-width">
                            <h3>Do you Transfer personal data outside Uganda ?</h3>
            
                            <mat-radio-group color="primary" aria-label="Pick one" formControlName="StoreDataOutsideCountry">
                                <mat-radio-button value="Yes">Yes</mat-radio-button>
                                <mat-radio-button value="No">No</mat-radio-button>
                            </mat-radio-group>        
                        </div> 
        
                        <section 
                            *ngIf="formThirdParties.get('StoreDataOutsideCountry').value === 'Yes'"
                            class="expand-section reduced-properties table-wrapper">
                            <button 
                                mat-button
                                color="primary"
                                [disabled]="processing"
                                class="add-item-button"
                                (click)="onAddACountry()">
                                <div class="button-label">
                                    <mat-icon>add</mat-icon>                            
                                    <span>Add A Country</span>
                                </div>
                            </button>
                            
                            <div class="table-wrapper">
                                <table 
                                    mat-table 
                                    #countryOfTransferMatSort="matSort"
                                    matSortDisableClear="true"
                                    [dataSource]="countriesDataSource"
                                    matSort>
                    
                                    <ng-container matColumnDef="Count">
                                        <th mat-header-cell *matHeaderCellDef> # </th>
                                        <td mat-cell *matCellDef="let index = index"> {{ index + 1 }} </td>
                                    </ng-container>
                    
                                    <ng-container matColumnDef="Country">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Country </th>
                                        <td mat-cell *matCellDef="let row">{{ row.Country }}</td>
                                    </ng-container>          
                    
                                    <ng-container matColumnDef="Purpose">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Purpose </th>
                                        <td mat-cell *matCellDef="let row">{{ row.Purpose }}</td>
                                    </ng-container>                                 
                    
                                    <ng-container matColumnDef="Description">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Description </th>
                                        <td mat-cell *matCellDef="let row">{{ row.Description }}</td>
                                    </ng-container>                                 
                    
                                    <!-- Actions Column -->
                                    <ng-container matColumnDef="Actions">
                                        <th mat-header-cell *matHeaderCellDef> Actions </th>
                                        <td mat-cell *matCellDef="let row; let index = index">
                                            <button 
                                                mat-button 
                                                class="action-btn"
                                                [matMenuTriggerFor]="menu" 
                                                (click)="$event.stopPropagation()"
                                                matTooltip="See more options">
                                                <mat-icon>more_vert</mat-icon>
                                            </button>
                    
                                            <mat-menu yPosition="below" #menu="matMenu" class="more-options-mat-menu">
                    
                                                <button 
                                                    mat-menu-item 
                                                    (click)="$event.stopPropagation();onEditCountry(row)">
                                                    <mat-icon>edit</mat-icon>
                                                    <span>Make Changes</span>
                                                </button>
                                                      
                                                <hr />
                    
                                                <button 
                                                    mat-menu-item 
                                                    (click)="$event.stopPropagation();onRemoveCountry(row)">
                                                    <mat-icon color="warn">delete</mat-icon>
                                                    <span>Remove</span>
                                                </button>
                    
                                            </mat-menu>                                                  
                                        </td>
                                    </ng-container>
                    
                                    <tr mat-header-row *matHeaderRowDef="countryDisplayedColumns"></tr>
                                    <tr mat-row *matRowDef="let row; columns: countryDisplayedColumns;" class="mat-data-row"></tr>
                                </table>
        
                                <mat-paginator 
                                    #countryOfTransferPaginator
                                    [pageSize]="10"
                                    [pageSizeOptions]="[5, 10]">
                                </mat-paginator>                    
                            </div>                
                        </section>                   
        
                    </form>
        
                    <div class="button-wrapper">
                        <button mat-button class="back-btn" matStepperPrevious>Back</button>
                        
                  

                        <button 
                            mat-button 
                            [disabled]="formThirdParties.invalid 
                            || processing 
                            || ((formThirdParties.get('PersonalDataIsForDisclosure').value === 'Yes') && (thirdParties.length === 0)) 
                            || ((formThirdParties.get('StoreDataOutsideCountry').value === 'Yes') && (countries.length === 0))" 
                            class="next-btn" 
                            color="primary" 
                            matStepperNext>
                            Next
                        </button>
                    </div>
                </mat-step>
        
                <mat-step [stepControl]="formSecurityMeasures">
                    <ng-template matStepLabel>
                        <h3>Security Information</h3>
                    </ng-template>
        
                    <form [formGroup]="formSecurityMeasures">
        
                        <h1 class="full-width step-header">State security measures in place to safeguard personal data collected or processed.</h1>
        
                        <section class="expand-section reduced-properties table-wrapper no-padding">
                            <button 
                                mat-button
                                color="primary"
                                [disabled]="processing"
                                class="add-item-button"
                                (click)="onAddSecurityMeasure()">
                                <div class="button-label">
                                    <mat-icon>add</mat-icon>                            
                                    <span>Add A Security Measure</span>
                                </div>
                            </button>
                            
                            <div class="table-wrapper">
                                <table 
                                    mat-table 
                                    #securityMeasureMatSort="matSort"
                                    matSortDisableClear="true"
                                    [dataSource]="securityMeasureDataSource"
                                    matSort>
                    
                                    <ng-container matColumnDef="Count">
                                        <th mat-header-cell *matHeaderCellDef> # </th>
                                        <td mat-cell *matCellDef="let index = index"> {{ index + 1 }} </td>
                                    </ng-container>
                    
                                    <ng-container matColumnDef="SecurityMeasure">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Security Measure </th>
                                        <td mat-cell *matCellDef="let row">{{ row.SecurityMeasure }}</td>
                                    </ng-container>                                  
                    
                                    <!-- Actions Column -->
                                    <ng-container matColumnDef="Actions">
                                        <th mat-header-cell *matHeaderCellDef> Actions </th>
                                        <td mat-cell *matCellDef="let row; let index = index">
                                            <button 
                                                mat-button 
                                                class="action-btn"
                                                [matMenuTriggerFor]="menu" 
                                                (click)="$event.stopPropagation()"
                                                matTooltip="See more options">
                                                <mat-icon>more_vert</mat-icon>
                                            </button>
                    
                                            <mat-menu yPosition="below" #menu="matMenu" class="more-options-mat-menu">
                
                                                <button 
                                                    mat-menu-item 
                                                    (click)="$event.stopPropagation();onEditSecurityMeasure(row)">
                                                    <mat-icon>edit</mat-icon>
                                                    <span>Make Changes</span>
                                                </button>
                                                      
                                                <hr />
                    
                                                <button 
                                                    mat-menu-item 
                                                    (click)="$event.stopPropagation();onRemoveSecurityMeasure(row)">
                                                    <mat-icon color="warn">delete</mat-icon>
                                                    <span>Remove</span>
                                                </button>                                        
                    
                                            </mat-menu>                                                  
                                        </td>
                                    </ng-container>
                    
                                    <tr mat-header-row *matHeaderRowDef="securityMeasuresDisplayedColumns"></tr>
                                    <tr mat-row *matRowDef="let row; columns: securityMeasuresDisplayedColumns;" [ngClass]="{'selected-mat-data-row': selectedSpouse === row}" class="mat-data-row"></tr>
                                </table>
        
                                <mat-paginator 
                                    #securityMeasurePaginator
                                    [pageSize]="10"
                                    [pageSizeOptions]="[5, 10]">
                                </mat-paginator>                    
                            </div>                
                        </section>    
                        
                        <section class="expand-section reduced-properties table-wrapper margin documents">
                            <h1 class="full-width step-header">Attach supporting documentation eg approved information security policy.</h1>
        
                            <div class="buttons">
                                <button 
                                    mat-button
                                    color="primary"
                                    [disabled]="processing"
                                    class="add-item-button"
                                    (click)="onUploadAttachments()">
                                    <div class="button-label">
                                        <mat-icon>add</mat-icon>                            
                                        <span> {{ document ? 'Replace Document' : 'Upload Attachment' }} </span>
                                    </div>
                                </button>
            
                                <button 
                                    mat-button
                                    *ngIf="document"
                                    color="primary"
                                    [disabled]="processing"
                                    class="remove-button"
                                    (click)="onRemoveDocument()">
                                    <div class="button-label">
                                        <mat-icon>clear</mat-icon>
                                        <span> Remove Document </span>
                                    </div>
                                </button>
                            </div>
        
                            <div *ngIf="document" class="uploaded-document" matTooltip="Open Document" (click)="onReadDocument(document)">
                                <img src="./assets/img/pdf.png" alt="">
        
                                <span>Document: {{ document.Name }} <span>  -  {{ document.Size }} Mbs</span></span>
                            </div>
        
                        </section>
        
                        <hr class="full-width" />
        
                        
                        
        
                        <hr class="full-width" />
        
                        <mat-checkbox
                            class="full-width"
                            formControlName="RegistrationConsent"
                            color="primary">
                            I certify that the above information is correct and complete and here by apply to be registered as 
                            data collector/ data processor / data controller (This shall be based on th category selected) 
                            under the data Protection and Privacy Act.
                            <mat-error *ngIf="formSecurityMeasures.get('RegistrationConsent').invalid">{{ getCheckboxErrorMessage() }}</mat-error>   
                        </mat-checkbox>       
                        
                        <mat-form-field class="full-width" hintLabel="The person authorized to complete and submit this application on the behalf of the applicant organization">
                            <mat-label>Name and title of person submitting the application<span class="required-field">required</span></mat-label>
                            <input appUppercase #RegistrationDoneByInput matInput maxlength="50" formControlName="RegistrationDoneBy">  
                            <mat-error *ngIf="formSecurityMeasures.get('RegistrationDoneBy').invalid">{{ getRegistrationDoneByErrorMessage() }}</mat-error>                             
                            <mat-hint align="end">{{ RegistrationDoneByInput.value.length }} / 50</mat-hint>    
                        </mat-form-field>                  
        
                    </form>
        
                    <div class="button-wrapper">
                        <button mat-button class="back-btn" matStepperPrevious>Back</button>

                                     

                        <div class="buttons">
                            <button
                                mat-button
                                color="primary" 
                                [disabled]="formGeneralInformation.invalid || formOrganisationDetails.invalid || formPersonalDataHeld.invalid || formPurposeRetention.invalid || formThirdParties.invalid || formSecurityMeasures.invalid || processing || securityMeasures.length === 0 || !documentForm3 || !proofOfPayment" 
                                class="download" 
                                matTooltip="Keep a copy of the information you have filled in"
                                (click)="onPreviewForm(true)">
                                <div class="button-label">
                                    <mat-icon>sim_card_download</mat-icon>
                                    <span>Download</span>
                                </div>
                            </button>
        
                            <button
                                mat-button
                                color="primary" 
                                [disabled]="formGeneralInformation.invalid || formOrganisationDetails.invalid || formPersonalDataHeld.invalid || formPurposeRetention.invalid || formThirdParties.invalid || formSecurityMeasures.invalid || processing || securityMeasures.length === 0 || !documentForm3 || !proofOfPayment" 
                                class="preview" 
                                matTooltip="Have a look at all the information you have filled in before sending."
                                (click)="onPreviewForm(false)">
                                <div class="button-label">
                                    <mat-icon>visibility</mat-icon>
                                    <span>Preview</span>
                                </div>
                            </button>
        
                        
                            <button 
                                mat-button 
                                class="next-btn submit-btn" 
                                [disabled]="formGeneralInformation.invalid || formOrganisationDetails.invalid || formPersonalDataHeld.invalid || formPurposeRetention.invalid || formThirdParties.invalid || formSecurityMeasures.invalid || processing || securityMeasures.length === 0 || !documentForm3 || !proofOfPayment" 
                                [ngClass]="{'inline-processing-btn': processing}" 
                                color="primary" 
                                (click)="onSubmit()">
                                <app-inline-mat-spinner *ngIf="processing"></app-inline-mat-spinner>                  
                                <span>Submit Application</span>                    
                            </button>                
                        </div>
                    </div>
                </mat-step>
        
            </mat-horizontal-stepper>   
        </main>
    </fury-page-layout-content>
</fury-page-layout>


